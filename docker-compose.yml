version: '3.7'

services:

  school:
    build:
      context: ./school
      dockerfile: Dockerfile
    restart: always
    links:
      - mysql
    ports:
      - "80:80"
      - "443:443"
      - "10022:22"
    volumes:
      - ./school/:/school/
      - ./:/docker/
    # cap and privileged needed for slowlog
    cap_add:
      - SYS_PTRACE
    privileged: true
    env_file:
      - etc/environment.yml
      - etc/environment.development.yml
    environment:
      - VIRTUAL_HOST=mercuryschool.ru
      - VIRTUAL_PORT=80
      - POSTFIX_RELAYHOST=[mail]:1025
    stdin_open: true
    tty: true

  mysql:
    build:
      context: ./docker/mysql
      dockerfile: MySQL-5.7.Dockerfile
    restart: always
    ports:
      - '13306:3306'
    command: --init-file /data/application/init.sql
    volumes:
      - mysql:/var/lib/mysql
      - ./mysql/init.sql:/data/application/init.sql
    env_file:
      - etc/environment.yml
      - etc/environment.development.yml

  board:
    volumes:
      - /opt/app/server-data:/opt/app/server-data
    ports:
      - '5001:443'
    build:
      context: ./school
      dockerfile: Dockerfile
    restart: on-failure
    deploy:
      restart_policy:
        condition: on-failure
    environment:
      - PORT=443

volumes:
  mysql: